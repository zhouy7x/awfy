{"version":3,"sources":["../src/prepack-node.js"],"names":["prepackStdin","prepackFile","prepackFileSync","options","processSerializedCode","printDiagnostics","sourceMapFilename","inputSourceMapFilename","process","stdin","setEncoding","resume","on","code","readFile","mapErr","sourceMap","console","warn","filename","serialized","filePath","fileContents","sourceMapContents","exit","err","error","stack","callback","fileErrorHandler","compatibility","fileErr","filenames","length","sourceFiles","map","readFileSync","_e","debugChannel","debugInFilePath","debugOutFilePath","debugOptions","ioWrapper","inFilePath","outFilePath"],"mappings":"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","file":"prepack-node.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/*\n Prepack API functions that require Node as the execution environment for Prepack.\n */\n\n/* @flow */\nimport { defaultOptions } from \"./options\";\nimport { FatalError } from \"./errors.js\";\nimport { type PrepackOptions } from \"./prepack-options\";\nimport { getDebuggerOptions } from \"./prepack-options\";\nimport { prepackNodeCLI, prepackNodeCLISync } from \"./prepack-node-environment.js\";\nimport { prepackSources } from \"./prepack-standalone.js\";\nimport { type SourceMap } from \"./types.js\";\nimport { DebugChannel } from \"./debugger/server/channel/DebugChannel.js\";\nimport { FileIOWrapper } from \"./debugger/common/channel/FileIOWrapper.js\";\nimport type { SerializedResult } from \"./serializer/types.js\";\n\nimport fs from \"fs\";\n\nexport * from \"./prepack-node-environment\";\nexport * from \"./prepack-standalone\";\n\nexport function prepackStdin(\n  options: PrepackOptions = defaultOptions,\n  processSerializedCode: SerializedResult => void,\n  printDiagnostics: () => boolean\n) {\n  let sourceMapFilename = options.inputSourceMapFilename || \"\";\n  process.stdin.setEncoding(\"utf8\");\n  process.stdin.resume();\n  process.stdin.on(\"data\", function(code) {\n    fs.readFile(sourceMapFilename, \"utf8\", function(mapErr, sourceMap) {\n      if (mapErr) {\n        //if no sourcemap was provided we silently ignore\n        if (sourceMapFilename !== \"\") console.warn(`No sourcemap found at ${sourceMapFilename}.`);\n        sourceMap = \"\";\n      }\n      let filename = \"no-filename-specified\";\n      let serialized;\n      try {\n        serialized = prepackSources(\n          [{ filePath: filename, fileContents: code, sourceMapContents: sourceMap }],\n          options\n        );\n        processSerializedCode(serialized);\n        if (printDiagnostics()) process.exit(1);\n      } catch (err) {\n        printDiagnostics();\n        if (!(err instanceof FatalError)) {\n          // if it is not a FatalError, it means prepack failed, and we should display the Prepack stack trace.\n          console.error(err.stack);\n        }\n        process.exit(1);\n      }\n    });\n  });\n}\n\nexport function prepackFile(\n  filename: string,\n  options: PrepackOptions = defaultOptions,\n  callback: (any, ?{ code: string, map?: SourceMap }) => void,\n  fileErrorHandler?: (err: ?Error) => void\n) {\n  if (options.compatibility === \"node-cli\") {\n    prepackNodeCLI(filename, options, callback);\n    return;\n  }\n  let sourceMapFilename = options.inputSourceMapFilename || filename + \".map\";\n  fs.readFile(filename, \"utf8\", function(fileErr, code) {\n    if (fileErr) {\n      if (fileErrorHandler) fileErrorHandler(fileErr);\n      return;\n    }\n    fs.readFile(sourceMapFilename, \"utf8\", function(mapErr, sourceMap) {\n      if (mapErr) {\n        console.warn(`No sourcemap found at ${sourceMapFilename}.`);\n        sourceMap = \"\";\n      }\n      let serialized;\n      try {\n        serialized = prepackSources(\n          [{ filePath: filename, fileContents: code, sourceMapContents: sourceMap }],\n          options\n        );\n      } catch (err) {\n        callback(err, null);\n        return;\n      }\n      callback(null, serialized);\n    });\n  });\n}\n\nexport function prepackFileSync(filenames: Array<string>, options: PrepackOptions = defaultOptions) {\n  if (options.compatibility === \"node-cli\") {\n    if (filenames.length !== 1) {\n      console.error(`Does not support multiple file prepack in node-cli mode.`);\n      process.exit(1);\n    }\n    return prepackNodeCLISync(filenames[0], options);\n  }\n  const sourceFiles = filenames.map(filename => {\n    let code = fs.readFileSync(filename, \"utf8\");\n    let sourceMap = \"\";\n    let sourceMapFilename = options.inputSourceMapFilename || filename + \".map\";\n    try {\n      sourceMap = fs.readFileSync(sourceMapFilename, \"utf8\");\n    } catch (_e) {\n      if (options.inputSourceMapFilename) console.warn(`No sourcemap found at ${sourceMapFilename}.`);\n    }\n    return { filePath: filename, fileContents: code, sourceMapContents: sourceMap };\n  });\n  let debugChannel;\n  if (options.debugInFilePath && options.debugOutFilePath) {\n    let debugOptions = getDebuggerOptions(options);\n    let ioWrapper = new FileIOWrapper(false, debugOptions.inFilePath, debugOptions.outFilePath);\n    debugChannel = new DebugChannel(ioWrapper);\n  }\n  return prepackSources(sourceFiles, options, debugChannel);\n}\n"]}