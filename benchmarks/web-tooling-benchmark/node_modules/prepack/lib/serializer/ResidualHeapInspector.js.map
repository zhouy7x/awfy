{"version":3,"sources":["../../src/serializer/ResidualHeapInspector.js"],"names":["ResidualHeapInspector","constructor","realm","logger","ignoredProperties","Map","_targetIntegrityCommands","getTargetIntegrityCommand","val","command","get","undefined","extensible","$Extensible","logError","value","anyWritable","anyConfigurable","propertyBinding","properties","values","desc","descriptor","configurable","writable","set","getTargetIntegrityDescriptor","_integrityDescriptors","isLeaf","hasIdentifier","isIntrinsic","canIgnoreProperty","key","_getIgnoredProperties","has","Set","_canIgnoreProperty","add","targetDescriptor","enumerable","intrinsics","null","hasDefaultLength","isCompatibleWith","MOBILE_JSC_VERSION","__originalName","$Strict","$FunctionKind","originalConstructor","kind","getKind","v","getPropertyValue","name","prototypeBinding","prototypeDesc","isDefaultPrototype","prototype","symbols","size","$Prototype","ObjectPrototype","mightNotBeTrue","foundConstructor","keys","preventExtensions","seal","freeze"],"mappings":";;;;;;;AAWA;;AAEA;;AACA;;AAaA;;;;AACA;;AACA;;;;AA7BA;;;;;;;;;AAiCO,MAAMA,qBAAN,CAA4B;AACjCC,cAAYC,KAAZ,EAA0BC,MAA1B,EAA0C;AACxC,SAAKD,KAAL,GAAaA,KAAb;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,iBAAL,GAAyB,IAAIC,GAAJ,EAAzB;AACA,SAAKC,wBAAL,GAAgC,IAAID,GAAJ,EAAhC;AACD;;AAODE,4BAA0BC,GAA1B,EAAoE;AAClE,QAAIC,UAAU,KAAKH,wBAAL,CAA8BI,GAA9B,CAAkCF,GAAlC,CAAd;AACA,QAAIC,YAAYE,SAAhB,EAA2B;AACzBF,gBAAU,EAAV;AACA,UAAID,iCAAJ,EAA+B;AAC7B;AACA;AACD,OAHD,MAGO;AACL,YAAII,aAAaJ,IAAIK,WAArB;AACA,YAAI,EAAED,0CAAF,CAAJ,EAA2C;AACzC,eAAKT,MAAL,CAAYW,QAAZ,CACEN,GADF,EAEE,wFAFF;AAID,SALD,MAKO,IAAI,CAACI,WAAWG,KAAhB,EAAuB;AAC5B,cAAIC,cAAc,KAAlB;AAAA,cACEC,kBAAkB,KADpB;AAEA,eAAK,IAAIC,eAAT,IAA4BV,IAAIW,UAAJ,CAAeC,MAAf,EAA5B,EAAqD;AACnD,gBAAIC,OAAOH,gBAAgBI,UAA3B;AACA,gBAAID,SAASV,SAAb,EAAwB,SAF2B,CAEjB;AAClC,gBAAIU,KAAKE,YAAT,EAAuBN,kBAAkB,IAAlB,CAAvB,KACK,IAAII,KAAKN,KAAL,KAAeJ,SAAf,IAA4BU,KAAKG,QAArC,EAA+CR,cAAc,IAAd;AACrD;AACDP,oBAAUQ,kBAAkB,mBAAlB,GAAwCD,cAAc,MAAd,GAAuB,QAAzE;AACD;AACF;AACD,WAAKV,wBAAL,CAA8BmB,GAA9B,CAAkCjB,GAAlC,EAAuCC,OAAvC;AACD;AACD,WAAOA,OAAP;AACD;;AASDiB,+BAA6BlB,GAA7B,EAA+C;AAC7C,WAAOR,sBAAsB2B,qBAAtB,CAA4C,KAAKpB,yBAAL,CAA+BC,GAA/B,CAA5C,CAAP;AACD;;AAED,SAAOoB,MAAP,CAAcpB,GAAd,EAAmC;AACjC,QAAIA,kCAAJ,EAAgC;AAC9B,aAAO,KAAP;AACD;;AAED,QAAIA,wCAAgCA,IAAIqB,aAAJ,EAApC,EAAyD;AACvD,aAAO,IAAP;AACD;;AAED,QAAIrB,IAAIsB,WAAJ,EAAJ,EAAuB;AACrB,aAAO,KAAP;AACD;;AAED,WAAOtB,qCAAP;AACD;;AAED;AACAuB,oBAAkBvB,GAAlB,EAAoCwB,GAApC,EAAiD;AAC/C,QAAIP,MAAM,KAAKrB,iBAAL,CAAuBM,GAAvB,CAA2BF,GAA3B,CAAV;AACA,QAAI,CAACiB,GAAL,EAAU;AACR,WAAKrB,iBAAL,CAAuBqB,GAAvB,CAA2BjB,GAA3B,EAAiCiB,MAAM,KAAKQ,qBAAL,CAA2BzB,GAA3B,CAAvC;AACD;AACD,WAAOiB,IAAIS,GAAJ,CAAQF,GAAR,CAAP;AACD;;AAEDC,wBAAsBzB,GAAtB,EAAwC;AACtC,QAAIiB,MAAmB,IAAIU,GAAJ,EAAvB;AACA,SAAK,IAAI,CAACH,GAAD,EAAMd,eAAN,CAAT,IAAmCV,IAAIW,UAAvC,EAAmD;AACjD,+BAAUD,eAAV;AACA,UAAIG,OAAOH,gBAAgBI,UAA3B;AACA,UAAID,SAASV,SAAb,EAAwB,SAHyB,CAGf;AAClC,UAAI,KAAKyB,kBAAL,CAAwB5B,GAAxB,EAA6BwB,GAA7B,EAAkCX,IAAlC,CAAJ,EAA6CI,IAAIY,GAAJ,CAAQL,GAAR;AAC9C;AACD,WAAOP,GAAP;AACD;;AAEDW,qBAAmB5B,GAAnB,EAAqCwB,GAArC,EAAkDX,IAAlD,EAAoE;AAClE,QAAIiB,mBAAmB,KAAKZ,4BAAL,CAAkClB,GAAlC,CAAvB;;AAEA,QAAI,oBAAQ,KAAKN,KAAb,EAAoBM,GAApB,CAAJ,EAA8B;AAC5B,UAAIwB,QAAQ,QAAR,IAAoBX,KAAKG,QAAL,KAAkBc,iBAAiBd,QAAvD,IAAmE,CAACH,KAAKkB,UAAzE,IAAuF,CAAClB,KAAKE,YAAjG,EAA+G;AAC7G;AACA,eAAO,IAAP;AACD;AACF,KALD,MAKO,IAAI,2BAAef,GAAf,CAAJ,EAAyB;AAC9B;AACA;AACA,UAAIwB,QAAQ,UAAR,IAAsBA,QAAQ,QAA9B,IAA0CA,QAAQ,QAAtD,EAAgE;AAC9D,eAAO,IAAP;AACD;AACD,UAAI,CAACA,QAAQ,KAAR,IAAiBA,QAAQ,KAA1B,KAAoCX,KAAKN,KAAL,KAAe,KAAKb,KAAL,CAAWsC,UAAX,CAAsBC,IAA7E,EAAmF;AACjF,eAAO,IAAP;AACD;AACF,KATM,MASA,IAAIjC,oCAAJ,EAAkC;AACvC,UAAIwB,QAAQ,QAAZ,EAAsB;AACpB,YAAIX,KAAKN,KAAL,KAAeJ,SAAnB,EAA8B;AAC5B,eAAKR,MAAL,CAAYW,QAAZ,CAAqBN,GAArB,EAA0B,+EAA1B;AACA;AACD;AACD;AACA,eACE,CAACa,KAAKG,QAAN,IACA,CAACH,KAAKkB,UADN,IAEAlB,KAAKE,YAAL,KAAsBe,iBAAiBf,YAFvC,IAGAf,IAAIkC,gBAAJ,EAJF;AAMD;;AAED,UAAIV,QAAQ,MAAZ,EAAoB;AAClB;AACA;AACA;AACA;AACA;AACA,YACEX,KAAKN,KAAL,KAAeJ,SAAf,IACA,CAAC,KAAKT,KAAL,CAAWyC,gBAAX,CAA4B,KAAKzC,KAAL,CAAW0C,kBAAvC,CADD,IAEA,CAAC,KAAK1C,KAAL,CAAWyC,gBAAX,CAA4B,QAA5B,CAFD,KAGCtB,KAAKN,KAAL,qCACEP,IAAIqC,cAAJ,IAAsBrC,IAAIqC,cAAJ,KAAuB,EAA7C,IAAmDxB,KAAKN,KAAL,CAAWA,KAAX,KAAqBP,IAAIqC,cAJ/E,CADF,EAOE,OAAO,KAAP;AACF,eAAO,IAAP;AACD;;AAED;AACA;AACA,UAAIb,QAAQ,WAAR,IAAuBA,QAAQ,QAAnC,EAA6C;AAC3C,iCAAUxB,oDAAV;AACA,YACE,CAACA,IAAIsC,OAAL,IACAzB,KAAKG,QAAL,MAAmB,CAAChB,IAAIsC,OAAL,IAAgBR,iBAAiBd,QAApD,CADA,IAEA,CAACH,KAAKkB,UAFN,IAGAlB,KAAKE,YAAL,KAAsBe,iBAAiBf,YAHvC,IAIAF,KAAKN,KAAL,kCAJA,IAKAP,IAAIuC,aAAJ,KAAsB,QANxB,EAQE,OAAO,IAAP;AACH;;AAED;AACA,UAAIf,QAAQ,WAAZ,EAAyB;AACvB,YACE,CAACX,KAAKE,YAAN,IACA,CAACF,KAAKkB,UADN,IAEAlB,KAAKG,QAAL,KAAkBc,iBAAiBd,QAFnC,IAGAH,KAAKN,KAAL,+BAHA,IAIAM,KAAKN,KAAL,CAAWiC,mBAAX,KAAmCxC,GALrC,EAME;AACA,iBAAO,IAAP;AACD;AACF;AACF,KA3DM,MA2DA;AACL,UAAIyC,OAAOzC,IAAI0C,OAAJ,EAAX;AACA,cAAQD,IAAR;AACE,aAAK,QAAL;AACE,cACEjB,QAAQ,WAAR,IACAX,KAAKG,QAAL,KAAkBc,iBAAiBd,QADnC,IAEA,CAACH,KAAKkB,UAFN,IAGA,CAAClB,KAAKE,YAJR,EAKE;AACA;AACA,gBAAI4B,IAAI9B,KAAKN,KAAb;AACA,mBAAOoC,oCAA4BA,EAAEpC,KAAF,KAAY,CAA/C;AACD;AACD;AACF;AACE;AAdJ;AAgBD;;AAED,QAAIiB,QAAQ,aAAZ,EAA2B;AACzB,UACEX,KAAKE,YAAL,KAAsBe,iBAAiBf,YAAvC,IACA,CAACF,KAAKkB,UADN,IAEAlB,KAAKG,QAAL,KAAkBc,iBAAiBd,QAFnC,IAGAH,KAAKN,KAAL,KAAeP,IAAIwC,mBAJrB,EAME,OAAO,IAAP;AACH;;AAED,WAAO,KAAP;AACD;;AAED,SAAOI,gBAAP,CAAwB5C,GAAxB,EAA0C6C,IAA1C,EAAsE;AACpE,QAAIC,mBAAmB9C,IAAIW,UAAJ,CAAeT,GAAf,CAAmB2C,IAAnB,CAAvB;AACA,QAAIC,qBAAqB3C,SAAzB,EAAoC,OAAOA,SAAP;AACpC,QAAI4C,gBAAgBD,iBAAiBhC,UAArC;AACA,QAAIiC,kBAAkB5C,SAAtB,EAAiC,OAAOA,SAAP;AACjC,6BAAU4C,cAAcxC,KAAd,KAAwBJ,SAAxB,IAAqC4C,cAAcxC,KAAd,yBAA/C;AACA,WAAOwC,cAAcxC,KAArB;AACD;;AAEDyC,qBAAmBC,SAAnB,EAAoD;AAClD,QACEA,UAAUC,OAAV,CAAkBC,IAAlB,KAA2B,CAA3B,IACAF,UAAUG,UAAV,KAAyB,KAAK1D,KAAL,CAAWsC,UAAX,CAAsBqB,eAD/C,IAEAJ,UAAU5C,WAAV,CAAsBiD,cAAtB,EAHF,EAIE;AACA,aAAO,KAAP;AACD;AACD,QAAIC,mBAAmB,KAAvB;AACA,SAAK,IAAIV,IAAT,IAAiBI,UAAUtC,UAAV,CAAqB6C,IAArB,EAAjB,EACE,IACEX,SAAS,aAAT,IACArD,sBAAsBoD,gBAAtB,CAAuCK,SAAvC,EAAkDJ,IAAlD,MAA4DI,UAAUT,mBAFxE,EAIEe,mBAAmB,IAAnB,CAJF,KAKK,OAAO,KAAP;AACP,WAAOA,gBAAP;AACD;AAlOgC;QAAtB/D,qB,GAAAA,qB;AAAAA,qB,CA4CJ2B,qB,GAAwB;AAC7B,MAAI,EAAEH,UAAU,IAAZ,EAAkBD,cAAc,IAAhC,EADyB;AAE7B0C,qBAAmB,EAAEzC,UAAU,IAAZ,EAAkBD,cAAc,IAAhC,EAFU;AAG7B2C,QAAM,EAAE1C,UAAU,IAAZ,EAAkBD,cAAc,KAAhC,EAHuB;AAI7B4C,UAAQ,EAAE3C,UAAU,KAAZ,EAAmBD,cAAc,KAAjC;AAJqB,C","file":"ResidualHeapInspector.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport { Realm } from \"../realm.js\";\nimport type { Descriptor } from \"../types.js\";\nimport { IsArray } from \"../methods/index.js\";\nimport {\n  SymbolValue,\n  BooleanValue,\n  AbstractValue,\n  FunctionValue,\n  ECMAScriptSourceFunctionValue,\n  NumberValue,\n  Value,\n  ObjectValue,\n  PrimitiveValue,\n  UndefinedValue,\n  ProxyValue,\n} from \"../values/index.js\";\nimport invariant from \"../invariant.js\";\nimport { Logger } from \"../utils/logger.js\";\nimport { isReactElement } from \"../react/utils.js\";\n\ntype TargetIntegrityCommand = \"freeze\" | \"seal\" | \"preventExtensions\" | \"\";\n\nexport class ResidualHeapInspector {\n  constructor(realm: Realm, logger: Logger) {\n    this.realm = realm;\n    this.logger = logger;\n    this.ignoredProperties = new Map();\n    this._targetIntegrityCommands = new Map();\n  }\n\n  realm: Realm;\n  logger: Logger;\n  ignoredProperties: Map<ObjectValue, Set<string>>;\n  _targetIntegrityCommands: Map<ObjectValue, TargetIntegrityCommand>;\n\n  getTargetIntegrityCommand(val: ObjectValue): TargetIntegrityCommand {\n    let command = this._targetIntegrityCommands.get(val);\n    if (command === undefined) {\n      command = \"\";\n      if (val instanceof ProxyValue) {\n        // proxies don't participate in regular object freezing/sealing,\n        // only their underlying proxied objects do\n      } else {\n        let extensible = val.$Extensible;\n        if (!(extensible instanceof BooleanValue)) {\n          this.logger.logError(\n            val,\n            \"Object that might or might not be sealed or frozen are not supported in residual heap.\"\n          );\n        } else if (!extensible.value) {\n          let anyWritable = false,\n            anyConfigurable = false;\n          for (let propertyBinding of val.properties.values()) {\n            let desc = propertyBinding.descriptor;\n            if (desc === undefined) continue; //deleted\n            if (desc.configurable) anyConfigurable = true;\n            else if (desc.value !== undefined && desc.writable) anyWritable = true;\n          }\n          command = anyConfigurable ? \"preventExtensions\" : anyWritable ? \"seal\" : \"freeze\";\n        }\n      }\n      this._targetIntegrityCommands.set(val, command);\n    }\n    return command;\n  }\n\n  static _integrityDescriptors = {\n    \"\": { writable: true, configurable: true },\n    preventExtensions: { writable: true, configurable: true },\n    seal: { writable: true, configurable: false },\n    freeze: { writable: false, configurable: false },\n  };\n\n  getTargetIntegrityDescriptor(val: ObjectValue) {\n    return ResidualHeapInspector._integrityDescriptors[this.getTargetIntegrityCommand(val)];\n  }\n\n  static isLeaf(val: Value): boolean {\n    if (val instanceof SymbolValue) {\n      return false;\n    }\n\n    if (val instanceof AbstractValue && val.hasIdentifier()) {\n      return true;\n    }\n\n    if (val.isIntrinsic()) {\n      return false;\n    }\n\n    return val instanceof PrimitiveValue;\n  }\n\n  // Object properties which have the default value can be ignored by the serializer.\n  canIgnoreProperty(val: ObjectValue, key: string) {\n    let set = this.ignoredProperties.get(val);\n    if (!set) {\n      this.ignoredProperties.set(val, (set = this._getIgnoredProperties(val)));\n    }\n    return set.has(key);\n  }\n\n  _getIgnoredProperties(val: ObjectValue) {\n    let set: Set<string> = new Set();\n    for (let [key, propertyBinding] of val.properties) {\n      invariant(propertyBinding);\n      let desc = propertyBinding.descriptor;\n      if (desc === undefined) continue; //deleted\n      if (this._canIgnoreProperty(val, key, desc)) set.add(key);\n    }\n    return set;\n  }\n\n  _canIgnoreProperty(val: ObjectValue, key: string, desc: Descriptor) {\n    let targetDescriptor = this.getTargetIntegrityDescriptor(val);\n\n    if (IsArray(this.realm, val)) {\n      if (key === \"length\" && desc.writable === targetDescriptor.writable && !desc.enumerable && !desc.configurable) {\n        // length property has the correct descriptor values\n        return true;\n      }\n    } else if (isReactElement(val)) {\n      // we don't want to visit/serialize $$typeof, _owner and _store properties\n      // as these are all internals of JSX/createElement\n      if (key === \"$$typeof\" || key === \"_owner\" || key === \"_store\") {\n        return true;\n      }\n      if ((key === \"ref\" || key === \"key\") && desc.value === this.realm.intrinsics.null) {\n        return true;\n      }\n    } else if (val instanceof FunctionValue) {\n      if (key === \"length\") {\n        if (desc.value === undefined) {\n          this.logger.logError(val, \"Functions with length accessor properties are not supported in residual heap.\");\n          // Rationale: .bind() would call the accessor, which might throw, mutate state, or do whatever...\n        }\n        // length property will be inferred already by the amount of parameters\n        return (\n          !desc.writable &&\n          !desc.enumerable &&\n          desc.configurable === targetDescriptor.configurable &&\n          val.hasDefaultLength()\n        );\n      }\n\n      if (key === \"name\") {\n        // TODO #474: Make sure that we retain original function names. Or set name property.\n        // Or ensure that nothing references the name property.\n        // NOTE: with some old runtimes notably JSC, function names are not configurable\n        // For now don't ignore the property if it is different from the function name.\n        // I.e. if it was set explicitly in the code, retain it.\n        if (\n          desc.value !== undefined &&\n          !this.realm.isCompatibleWith(this.realm.MOBILE_JSC_VERSION) &&\n          !this.realm.isCompatibleWith(\"mobile\") &&\n          (desc.value instanceof AbstractValue ||\n            (val.__originalName && val.__originalName !== \"\" && desc.value.value !== val.__originalName))\n        )\n          return false;\n        return true;\n      }\n\n      // Properties `caller` and `arguments` are added to normal functions in non-strict mode to prevent TypeErrors.\n      // Because they are autogenerated, they should be ignored.\n      if (key === \"arguments\" || key === \"caller\") {\n        invariant(val instanceof ECMAScriptSourceFunctionValue);\n        if (\n          !val.$Strict &&\n          desc.writable === (!val.$Strict && targetDescriptor.writable) &&\n          !desc.enumerable &&\n          desc.configurable === targetDescriptor.configurable &&\n          desc.value instanceof UndefinedValue &&\n          val.$FunctionKind === \"normal\"\n        )\n          return true;\n      }\n\n      // ignore the `prototype` property when it's the right one\n      if (key === \"prototype\") {\n        if (\n          !desc.configurable &&\n          !desc.enumerable &&\n          desc.writable === targetDescriptor.writable &&\n          desc.value instanceof ObjectValue &&\n          desc.value.originalConstructor === val\n        ) {\n          return true;\n        }\n      }\n    } else {\n      let kind = val.getKind();\n      switch (kind) {\n        case \"RegExp\":\n          if (\n            key === \"lastIndex\" &&\n            desc.writable === targetDescriptor.writable &&\n            !desc.enumerable &&\n            !desc.configurable\n          ) {\n            // length property has the correct descriptor values\n            let v = desc.value;\n            return v instanceof NumberValue && v.value === 0;\n          }\n          break;\n        default:\n          break;\n      }\n    }\n\n    if (key === \"constructor\") {\n      if (\n        desc.configurable === targetDescriptor.configurable &&\n        !desc.enumerable &&\n        desc.writable === targetDescriptor.writable &&\n        desc.value === val.originalConstructor\n      )\n        return true;\n    }\n\n    return false;\n  }\n\n  static getPropertyValue(val: ObjectValue, name: string): void | Value {\n    let prototypeBinding = val.properties.get(name);\n    if (prototypeBinding === undefined) return undefined;\n    let prototypeDesc = prototypeBinding.descriptor;\n    if (prototypeDesc === undefined) return undefined;\n    invariant(prototypeDesc.value === undefined || prototypeDesc.value instanceof Value);\n    return prototypeDesc.value;\n  }\n\n  isDefaultPrototype(prototype: ObjectValue): boolean {\n    if (\n      prototype.symbols.size !== 0 ||\n      prototype.$Prototype !== this.realm.intrinsics.ObjectPrototype ||\n      prototype.$Extensible.mightNotBeTrue()\n    ) {\n      return false;\n    }\n    let foundConstructor = false;\n    for (let name of prototype.properties.keys())\n      if (\n        name === \"constructor\" &&\n        ResidualHeapInspector.getPropertyValue(prototype, name) === prototype.originalConstructor\n      )\n        foundConstructor = true;\n      else return false;\n    return foundConstructor;\n  }\n}\n"]}